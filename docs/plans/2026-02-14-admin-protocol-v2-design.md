# Admin Protocol v2: Kind 24207 + NIP-44

## Problem

Admin communication currently uses NIP-04 encrypted DMs (kind 4), which pollutes the admin's DM inbox in Nostr clients. We need an ephemeral, non-DM event kind with modern encryption.

## Design

### Event Protocol

- **Kind:** `24207` (ephemeral range 20000-29999 — relays do not store these)
- **Encryption:** NIP-44 (replaces NIP-04)
- **Pattern:** NIP-46-style RPC with `method`/`params` request and `result`/`error` response, correlated by a random `id`

### Request (admin → DVM)

```json
{
  "kind": 24207,
  "pubkey": "<admin_pubkey>",
  "content": "<nip44_encrypt({id, method, params})>",
  "tags": [["p", "<dvm_pubkey>"]]
}
```

### Response (DVM → admin)

```json
{
  "kind": 24207,
  "pubkey": "<dvm_pubkey>",
  "content": "<nip44_encrypt({id, result?, error?})>",
  "tags": [["p", "<admin_pubkey>"]]
}
```

- `id`: random hex string generated by requester, echoed in response
- `result` and `error` are mutually exclusive

### Method Reference

| Method | Params | Response (`result`) |
|---|---|---|
| `claim_admin` | `{secret}` | `{msg}` |
| `get_config` | `{}` | `ConfigResponse` |
| `set_relays` | `{relays: [...]}` | `ConfigResponse` |
| `set_blossom_servers` | `{servers: [...]}` | `ConfigResponse` |
| `set_blob_expiration` | `{days: N}` | `ConfigResponse` |
| `set_profile` | `{name, about}` | `ConfigResponse` |
| `set_config` | `{relays?, servers?, ...}` | `ConfigResponse` |
| `pause` | `{}` | `StatusResponse` |
| `resume` | `{}` | `StatusResponse` |
| `status` | `{}` | `StatusResponse` |
| `job_history` | `{limit?}` | `JobHistoryResponse` |
| `get_dashboard` | `{limit?}` | `DashboardResponse` |
| `self_test` | `{}` | `SelfTestResponse` |
| `system_info` | `{}` | `SystemInfoResponse` |
| `import_env_config` | `{}` | `ConfigResponse` |

## Backend Changes

### `src/admin/commands.rs`

New wire types for serialization/deserialization:

```rust
struct AdminRequest {
    id: String,
    method: String,
    params: serde_json::Value,
}

struct AdminResponseWire {
    id: String,
    #[serde(skip_serializing_if = "Option::is_none")]
    result: Option<ResponseData>,
    #[serde(skip_serializing_if = "Option::is_none")]
    error: Option<String>,
}
```

Internal `AdminCommand` enum and `AdminResponse` struct remain as-is. `AdminRequest` converts to `AdminCommand` for processing. `AdminResponseWire` wraps `AdminResponse` with correlation `id`.

### `src/admin/listener.rs`

- Subscribe to `Kind::Custom(24207)` instead of `Kind::Custom(4)`
- Replace `nip04::decrypt` → `nip44::decrypt`
- Replace `nip04::encrypt` → `nip44::encrypt`
- Parse `AdminRequest` from decrypted JSON, extract `id`
- Convert `method` + `params` → `AdminCommand`
- Wrap response in `AdminResponseWire` with the same `id`
- Build event with `Kind::Custom(24207)` + `p`-tag

## Frontend Changes

### `frontend/src/nostr/admin.ts`

**`sendAdminCommand()`:**
- Generate random `id` (32-char hex)
- Wrap command as `{id, method, params}` instead of `{cmd, ...flat_fields}`
- Replace `signer.nip04.encrypt()` → `signer.nip44.encrypt()`
- Build event with `kind: 24207` instead of `kind: 4`
- Return `id` for response correlation

**`subscribeToAdminResponses()`:**
- Subscribe to `kind: 24207` (authors: dvmPubkey, #p: adminPubkey)
- Replace `signer.nip04.decrypt()` → `signer.nip44.decrypt()`
- Parse response as `{id, result?, error?}`

## Not Changed

- `src/admin/handler.rs` — Internal command/response types and logic unchanged
- `src/dvm/encryption.rs` — Still used by DVM job protocol (NIP-04)
- `src/dvm/events.rs` — DVM job encryption unchanged

## No Backward Compatibility

Once deployed, the DVM only speaks kind 24207 / NIP-44. Old clients using kind 4 / NIP-04 will be silently ignored.

## Deliverables

1. New wire types in `src/admin/commands.rs`
2. NIP-44 + kind 24207 listener in `src/admin/listener.rs`
3. Frontend NIP-44 + kind 24207 + new wire format in `frontend/src/nostr/admin.ts`
4. Protocol spec & migration doc at `docs/admin-protocol.md`
