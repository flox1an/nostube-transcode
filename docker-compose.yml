# Docker Compose for DVM Video Processing with Intel QSV/VAAPI
#
# Quick start:
#   1. cp .env.example .env && edit .env (set OPERATOR_NPUB)
#   2. docker compose up -d
#   3. Open http://localhost:3000 to manage via the admin UI
#
# See docs/deployment.md for Intel GPU setup and group ID configuration.

services:
  dvm-video:
    build: .
    container_name: dvm-video-processing
    restart: unless-stopped

    # CRITICAL: Pass Intel GPU render device for QSV hardware acceleration
    devices:
      - /dev/dri:/dev/dri

    # Match host video/render group IDs for GPU access
    # Run `getent group video render` on host to find GIDs
    group_add:
      - "44"   # video group (default on Debian/Ubuntu)
      - "105"  # render group (from your host - check with: stat /dev/dri/renderD128)

    ports:
      - "3000:3000"

    volumes:
      # Persistent temp directory (optional, for debugging)
      - ./temp:/app/temp

    env_file:
      - .env

    environment:
      # Intel QSV - Use Intel Media Driver for AV1/HEVC hardware decode
      - LIBVA_DRIVER_NAME=iHD
      - HTTP_PORT=3000
      - TEMP_DIR=/app/temp
