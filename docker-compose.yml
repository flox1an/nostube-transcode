# Docker Compose for DVM Video Processing with Intel QSV
# Tested on UGREEN NAS (N100, Pentium Gold 8505, i5-1235U)

services:
  dvm-video:
    build: .
    container_name: dvm-video-processing
    restart: unless-stopped

    # CRITICAL: Pass Intel GPU render device for QSV hardware acceleration
    devices:
      - /dev/dri:/dev/dri

    # Match host video/render group IDs for GPU access
    # Run `getent group video render` on host to find GIDs
    group_add:
      - "44"   # video group (default on Debian/Ubuntu)
      - "105"  # render group (from your host - check with: stat /dev/dri/renderD128)

    ports:
      - "3000:3000"

    volumes:
      # Persistent temp directory (optional, for debugging)
      - ./temp:/app/temp

    environment:
      # Intel QSV - Use Intel Media Driver for AV1/HEVC hardware decode
      - LIBVA_DRIVER_NAME=iHD

      # Optional
      - BOOTSTRAP_RELAYS=${BOOTSTRAP_RELAYS:-wss://relay.damus.io,wss://nos.lol}
      - DVM_ADMIN_APP_URL=${DVM_ADMIN_APP_URL:-}
      - HTTP_PORT=3000
      - TEMP_DIR=/app/temp
      - RUST_LOG=${RUST_LOG:-info}
